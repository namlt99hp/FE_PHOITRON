<!-- <h2 mat-dialog-title>Phối trộn quặng</h2> -->

<mat-dialog-content class="content">
  <!-- Header: Thông tin công thức (ẩn riêng gang/plan nếu không có) -->
  <section class="section header-info">
    <h4 class="section-title">Thông tin tổng hợp</h4>
    <div class="info-card">
      <div
        class="info-row"
        *ngIf="(data?.gangId && gangName()) || (data?.planId && planName())"
      >
        <div class="info-item">
          <span class="info-label">Quặng gang đích:</span>
          <span class="info-value">{{ gangName() }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Phương án:</span>
          <span class="info-value">{{ planName() }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Ngày tạo:</span>
          <span class="info-value">{{
            data?.planNgayTao
              ? (data!.planNgayTao | date : "dd/MM/yyyy")
              : (today() | date : "dd/MM/yyyy")
          }}</span>
        </div>
      </div>
      <div class="info-row">
        <div class="info-item">
          <span class="info-label">Tên công thức:</span>
          <span class="info-value">{{
            tenCongThucCtrl.value || "Chưa nhập tên quặng"
          }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Mã công thức:</span>
          <span class="info-value">{{
            maCongThucCtrl.value || "Chưa nhập mã quặng"
          }}</span>
        </div>

        <div class="info-item">
          <span class="info-label">Loại quặng thành phẩm:</span>
          <span class="info-value">{{ outputLoaiQuangLabel }}</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Thông tin quặng mới tạo từ kết quả phối -->
  <section class="section">
    <h4 class="section-title">Thông tin quặng mới</h4>
    <div
      class="grid"
      [ngStyle]="{
        'grid-template-columns': getGridColumns()
      }"
    >
    <mat-form-field appearance="outline" class="dialog-input">
      <mat-label>Tên quặng</mat-label>
      <input
        matInput
        [formControl]="oreForm.controls.TenQuang"
        placeholder="VD: Quặng phối {{ data?.planName || '' }}"
      />
    </mat-form-field>
      <mat-form-field appearance="outline" class="dialog-input">
        <mat-label>Mã quặng</mat-label>
        <input
          matInput
          [formControl]="oreForm.controls.MaQuang"
          [readonly]="true"
          placeholder="Tự động tạo từ tên quặng"
        />
      </mat-form-field>
      
      <!-- Hiện select loại quặng khi mở từ Trộn quặng (Tron) hoặc Edit quặng trộn/vê viên (Tron | QuangVeVien) -->
      <mat-form-field 
        *ngIf="data?.outputLoaiQuang === LoaiQuangEnum.Tron || data?.outputLoaiQuang === LoaiQuangEnum.QuangVeVien"
        appearance="outline" 
        class="dialog-input"
      >
        <mat-label>Loại quặng</mat-label>
        <mat-select
          [value]="outputLoaiQuang()"
          (selectionChange)="outputLoaiQuang.set($event.value)"
        >
          <mat-option [value]="LoaiQuangEnum.Tron">Quặng trộn</mat-option>
          <mat-option [value]="LoaiQuangEnum.QuangVeVien">Vê viên</mat-option>
        </mat-select>
      </mat-form-field>
      
      <!-- Quặng trộn / Vê viên: chỉ hiện Loại quặng (đã có ở trên). Có planId và không phải trộn/vê viên: hiện Công đoạn. -->
      <mat-form-field
        *ngIf="data?.planId && outputLoaiQuang() !== LoaiQuangEnum.Tron && outputLoaiQuang() !== LoaiQuangEnum.QuangVeVien"
        appearance="outline"
        class="dialog-input"
      >
        <mat-label>Công đoạn</mat-label>
        <mat-select
          [value]="milestone()"
          (selectionChange)="milestone.set($event.value)"
        >
          <mat-option [value]="MilestoneEnum.Standard"
            >--- Chọn Công đoạn ---</mat-option
          >
          <mat-option [value]="MilestoneEnum.ThieuKet">Thiêu kết</mat-option>
          <mat-option [value]="MilestoneEnum.LoCao">Lò cao</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" class="dialog-input">
        <mat-label>Ngày tạo quặng</mat-label>
        <input
          matInput
          [matDatepicker]="pickerOre"
          [formControl]="oreForm.controls.NgayTao"
        />
        <mat-datepicker-toggle matSuffix [for]="pickerOre"></mat-datepicker-toggle>
        <mat-datepicker #pickerOre></mat-datepicker>
      </mat-form-field>
    </div>
    <div class="grid">
      <mat-form-field appearance="outline" class="dialog-input col-span-3">
        <mat-label>Ghi chú</mat-label>
        <input matInput [formControl]="oreForm.controls.GhiChu" />
      </mat-form-field>
    </div>
  </section>

  <!-- Chọn TPHH + nhập min/max -->
  <section class="section">
    <div class="section-header">
      <h3 class="section-title">Thành phần hoá học</h3>
      <button mat-stroked-button color="primary" (click)="openSelectChems()">
        <mat-icon>category</mat-icon>&nbsp;Chọn TPHH
      </button>
    </div>

    <div class="constraints" *ngIf="selectedChems().length > 0">
      <table class="constraints-table">
        <thead>
          <tr>
            <th class="stub">Ràng buộc</th>
            <th
              *ngFor="let c of displayedChems(); trackBy: trackChem"
              class="chem-col"
            >
              <div class="th-wrap">
                <span class="th-text" [title]="c.ma_TPHH">{{ c.ma_TPHH }}</span>
                <button
                  type="button"
                  class="remove-btn"
                  (click)="removeChem(c.id)"
                  matTooltip="Xóa TPHH này"
                  matTooltipPosition="above"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <th class="stub">Min (%)</th>
            <td *ngFor="let c of displayedChems(); trackBy: trackChem">
              <input
                type="number"
                min="0"
                step="0.01"
                class="cell-input text-right"
                [formControl]="getConstraintCtrl(c.id, 'min')"
              />
            </td>
          </tr>

          <tr>
            <th class="stub">Max (%)</th>
            <td *ngFor="let c of displayedChems(); trackBy: trackChem">
              <input
                type="number"
                min="0"
                step="0.01"
                class="cell-input text-right"
                [formControl]="getConstraintCtrl(c.id, 'max')"
              />
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Chọn quặng & Bảng phối -->
  <section class="section">
    <div class="section-table-tmp">
      @switch (milestone()) { @case (MilestoneEnum.LoCao) {
      <app-mix-quang-locao-section
        [selectedChems]="selectedChems()"
        [locaoControls]="locaoControls()"
        [updateTrigger]="updateTrigger()"
        [planId]="data?.planId || 0"
        (processParamsChange)="onProcessParamsChange($event)"
      />
      } @default {
      <!-- Default content for other milestones -->
      } }
    </div>
    <div class="section-header">
      <h3 class="section-title">Chọn quặng nguồn & nhập tỉ lệ phối</h3>
      <button
        mat-stroked-button
        color="primary"
        (click)="openSelectOres()"
        [disabled]="selectedChems().length === 0"
      >
        <mat-icon>inventory_2</mat-icon>&nbsp;Chọn quặng
      </button>
    </div>
    <div
      class="table-wrap"
      *ngIf="rows().length > 0 && selectedChems().length > 0"
    >
      <table class="mix-table">
        <thead>
          <tr>
            <th class="stub" rowspan="2">Quặng</th>
            <th class="group" colspan="1">Cột nhập tỉ lệ phối</th>
            <th
              class="group"
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              colspan="2"
            >
              Thiêu kết khấu hao
            </th>
            <th
              class="group"
              *ngIf="milestone() === MilestoneEnum.LoCao"
              colspan="3"
            >
              Thông tin phối
            </th>
            <th class="group" [attr.colspan]="getChemColumnsSpan()">
              Các thành phần hóa học
            </th>
            <th
              class="group"
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              colspan="5"
            >
              Vê viên
            </th>
          </tr>
          <tr>
            <th class="ratio-col">Tỷ lệ, %</th>
            <th
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              class="thieu-ket-col"
            >
              Khấu hao
            </th>
            <th
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              class="percentage-col"
            >
              Tỷ lệ khấu hao
            </th>
            <th
              *ngIf="milestone() === MilestoneEnum.LoCao"
              class="kl-vao-lo-col"
            >
              KL vào lò
            </th>
            <th
              *ngIf="milestone() === MilestoneEnum.LoCao"
              class="ty-le-hoi-quang-col"
            >
              Tỷ lệ hồi quặng
            </th>
            <th *ngIf="milestone() === MilestoneEnum.LoCao" class="kl-nhan-col">
              KL nhận
            </th>
            <th *ngFor="let c of displayedChems()" class="chem-col">{{ c.ma_TPHH }}</th>
            <th
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="sau-nung-col"
            >
              Sau nung
            </th>
            <th
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="tieu-hao-col"
            >
              Tiêu hao
            </th>
            <th
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="don-gia-col"
            >
              Đơn giá
            </th>
            <th
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="chi-phi-nghien-col"
              colspan="2"
            >
              Chi phí nghiền
            </th>
          </tr>
        </thead>

        <tbody>
          <!-- Hàng quặng nguồn -->
          <tr
            *ngFor="let r of rows(); let i = index"
            [class.mixed-ore-row]="r.loaiQuang === LoaiQuangEnum.QuangPA"
          >
            <th class="stub">
              <div class="ore-cell">
                <button
                  type="button"
                  class="remove-btn"
                  (click)="removeRow(r)"
                  matTooltip="Xóa quặng này"
                  matTooltipPosition="above"
                >
                  <mat-icon>close</mat-icon>
                </button>
                <div class="ore-name" [title]="r.tenQuang">
                  {{ r.tenQuang }}
                </div>
              </div>
            </th>

            <!-- tỷ lệ phối -->
            <td class="ratio-cell">
              <span
                *ngIf="r.loaiQuang === LoaiQuangEnum.QuangPA"
                class="calculated-value text-center"
              >{{ formatDynamic(getRatioForLoai7()) }}</span>
              <input
                *ngIf="r.loaiQuang !== LoaiQuangEnum.QuangPA"
                type="text"
                inputmode="decimal"
                class="cell-input text-center"
                [formControl]="r.ratioCtrl"
              />
            </td>

            <!-- Thiêu kết khấu hao -->
            <td
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              class="thieu-ket-cell text-right"
            >
              <span *ngIf="getThieuKetKhauHaoValue(r) !== 0">{{ formatDynamic(getThieuKetKhauHaoValue(r)) }}</span>
            </td>

            <!-- Thiêu kết: Tỷ lệ khấu hao (%) -->
            <td
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              class="percentage-cell text-right"
            >
              <span *ngIf="getThieuKetKhauHaoPercentage(r) !== 0">{{ formatDynamic(getThieuKetKhauHaoPercentage(r)) }}</span>
            </td>

            <!-- Lò cao: KL vào lò -->
            <td
              *ngIf="milestone() === MilestoneEnum.LoCao"
              class="kl-vao-lo-cell"
            >
              <span
                *ngIf="
                  isLocaoKlVaoLoCalculated(r) && getLocaoKlVaoLoValue(r) !== 0
                "
                class="calculated-value"
              >{{ formatDynamic(getLocaoKlVaoLoValue(r)) }}</span>
              <input
                *ngIf="!isLocaoKlVaoLoCalculated(r)"
                type="text"
                inputmode="decimal"
                class="cell-input text-center"
                [formControl]="r.klVaoLoCtrl"
              />
            </td>

            <!-- Lò cao: Tỷ lệ hồi quặng -->
            <td
              *ngIf="milestone() === MilestoneEnum.LoCao"
              class="ty-le-hoi-quang-cell"
            >
              <input
                *ngIf="r.loaiQuang !== LoaiQuangEnum.NhienLieu"
                type="text"
                inputmode="decimal"
                class="cell-input text-center"
                [formControl]="r.tyLeHoiQuangCtrl"
                placeholder="%"
              />
            </td>

            <!-- Lò cao: KL nhận -->
            <td
              *ngIf="milestone() === MilestoneEnum.LoCao"
              class="kl-nhan-cell"
            >
              <span 
                class="calculated-value text-center"
              >{{ formatDynamic(r.klNhanCtrl.value) }}</span>
            </td>

            <!-- các thành phần hoá học: hiển thị theo formatDynamic, cập nhật control khi nhập -->
            <td *ngFor="let c of displayedChems()" class="chem-cell">
              <input
                type="text"
                inputmode="decimal"
                class="cell-input text-right"
                [value]="formatDynamic(getChemCtrl(r, c.id).value)"
                (input)="onChemInput(r, c.id, $event)"
              />
            </td>

            <!-- Vê viên: Sau nung (tính tự động) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="sau-nung-cell"
            >
              <span class="calculated-value text-center">
                {{ formatDynamic(getSauNungValue(r)) }}
              </span>
            </td>

            <!-- Vê viên: Tiêu hao (tính tự động, cho phép chỉnh sửa) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="tieu-hao-cell"
            >
              <input
                type="text"
                inputmode="decimal"
                class="cell-input text-center"
                [formControl]="r.tieuHaoCtrl!"
              />
            </td>

            <!-- Vê viên: Đơn giá (hiển thị giá quặng) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="don-gia-cell"
            >
              <span class="calculated-value text-center">
                {{ formatDynamic(getDonGiaValue(r)) }}
              </span>
            </td>

            <!-- Vê viên: Chi phí nghiền -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="chem-cell chi-phi-nghien-cell"
              colspan="2"
            >
              <span
                *ngIf="r.tinhChiPhiNghienCtrl!.value"
                class="calculated-value text-center"
              >
                {{ formatDynamic(r.chiPhiNghienCtrl!.value) }}
              </span>
              <mat-slide-toggle
                class="chi-phi-nghien-toggle"
                [formControl]="r.tinhChiPhiNghienCtrl!"
                matTooltip="Bật để tính: Đơn giá nghiền × Tiêu hao"
                matTooltipPosition="above"
              ></mat-slide-toggle>
            </td>
          </tr>

          <!-- Dòng tổng & kết quả sau tính -->
          <tr *ngIf="milestone() !== MilestoneEnum.ThieuKet" class="result-row">
            <th class="stub">Tổng</th>
            <td class="text-center">{{ formatDynamic(totalRatio()) }}%</td>
            <td
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              class="text-right"
            >
              {{ formatDynamic(getTotalThieuKetKhauHao()) }}
            </td>
            <td
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              class="text-right"
            >
              {{ formatDynamic(getTotalThieuKetKhauHaoPercentage()) }}
            </td>
            <!-- Các cột tổng cho milestone Lò Cao -->
            <td *ngIf="milestone() === MilestoneEnum.LoCao" class="text-right">
              {{ formatDynamic(getTotalLocaoKlVaoLo()) }}
            </td>
            <td *ngIf="milestone() === MilestoneEnum.LoCao" class="text-right">
              {{ formatDynamic(getTotalLocaoTyLeHoiQuang()) }}%
            </td>
            <td *ngIf="milestone() === MilestoneEnum.LoCao" class="text-right">
              {{ formatDynamic(getTotalLocaoKlNhan()) }}
            </td>
            <td
              *ngFor="let c of displayedChems()"
              class="text-right"
              [class.out-range]="isOutOfRange(c.id)"
            >
              <span
                *ngIf="milestone() === MilestoneEnum.LoCao; else defaultTotal"
              >{{ formatDynamic(getChemTotalBySumProduct(c.id)) }}</span>
              <ng-template #defaultTotal>
                {{ formatDynamic(resultRow()[c.id]) }}
              </ng-template>
            </td>
            <!-- Vê viên: Tổng Sau nung -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="text-right"
            >
              {{ formatDynamic(getTotalSauNung()) }}
            </td>
            <!-- Vê viên: Tổng Tiêu hao (tính từ các giá trị đã nhập) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="text-right"
            >
              {{ formatDynamic(getTotalTieuHao()) }}
            </td>
            <!-- Vê viên: Đơn giá (để trống ở dòng tổng) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="text-right"
            >
              {{ formatDynamic(getVeVienTotalDonGia()) }}
            </td>
            <!-- Vê viên: Tổng Chi phí nghiền (chiếm 2 cột) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="text-right"
              colspan="2"
            >
            </td>
          </tr>

          <!-- Dòng Result 1 cho milestone ThieuKet: tỷ lệ x hàm lượng TPHH -->
          <tr *ngIf="milestone() === MilestoneEnum.ThieuKet" class="result-row">
            <th class="stub"></th>
            <td class="text-center">{{ formatDynamic(totalRatio()) }}%</td>
            <td class="text-right">
              {{ formatDynamic(getTotalThieuKetKhauHao()) }}
            </td>
            <td class="text-right">
              {{ formatDynamic(getTotalThieuKetKhauHaoPercentage()) }}
            </td>
            <td *ngFor="let c of selectedChems()" class="text-right">
              <span *ngIf="!shouldHideInResult1(c.id)">{{ formatDynamic(getThieuKetRow1Value(c.id)) }}</span>
              <span *ngIf="shouldHideInResult1(c.id)"><strong>R2</strong></span>
            </td>
            <!-- Vê viên: Tổng Sau nung (Result 1) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="text-right"
            >
              {{ formatDynamic(getTotalSauNung()) }}
            </td>
            <!-- Vê viên: Tổng Tiêu hao (Result 1) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="text-right"
            >
              {{ formatDynamic(getTotalTieuHao()) }}
            </td>
            <!-- Vê viên: Đơn giá (Result 1) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="text-right"
            >
              {{ formatDynamic(getVeVienTotalDonGia()) }}
            </td>
            <!-- Vê viên: Chi phí nghiền (Result 1, chiếm 2 cột) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="text-right"
              colspan="2"
            >
            </td>
          </tr>

          <!-- Dòng Result 2 cho milestone ThieuKet: Result 1 / tổng khấu hao -->
          <tr *ngIf="milestone() === MilestoneEnum.ThieuKet" class="result-row">
            <th class="stub">Tổng</th>
            <td class="text-center">-</td>
            <td class="text-right">-</td>
            <td class="text-right">-</td>
            <td
              *ngFor="let c of displayedChems()"
              class="text-right"
              [class.out-range]="isOutOfRange(c.id)"
            >
              <span *ngIf="c.ma_TPHH === 'MKN'">{{ formatDynamic(getThieuKetCaOSiO2Ratio()) }}</span>
              <span *ngIf="c.ma_TPHH !== 'MKN'">{{ formatDynamic(getThieuKetRow2Value(c.id)) }}</span>
            </td>
            <!-- Vê viên: Tổng Sau nung (Result 2) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="text-right"
            >
              {{ formatDynamic(getTotalSauNung()) }}
            </td>
            <!-- Vê viên: Tổng Tiêu hao (Result 2) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="text-right"
            >
              {{ formatDynamic(getTotalTieuHao()) }}
            </td>
            <!-- Vê viên: Đơn giá (Result 2) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="text-right"
            >
              {{ formatDynamic(getVeVienTotalDonGia()) }}
            </td>
            <!-- Vê viên: Chi phí nghiền (Result 2, chiếm 2 cột) -->
            <td
              *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
              class="text-right"
              colspan="2"
            >
            </td>
          </tr>
        </tbody>
      </table>
      <div 
        *ngIf="outputLoaiQuang() === LoaiQuangEnum.QuangVeVien"
        class="vevien-chiphinghien"
      >
        <div class="vevien-input-group">
          <label>Đơn giá nghiền:</label>
          <input 
            type="number" 
            [formControl]="veVienForm.controls.donGiaNghien"
            class="vevien-input"
          />
        </div>
        <div class="vevien-input-group">
          <label>Chi phí nghiền cố định:</label>
          <input 
            type="number" 
            [formControl]="veVienForm.controls.chiPhiNghienCoDinh"
            class="vevien-input"
          />
        </div>
      </div>
    </div>
    <!-- Locao Results Component - Hiển thị dưới bảng mix quặng -->
    <section
      class="locao-results-section"
      *ngIf="milestone() === MilestoneEnum.LoCao"
    >
      <app-locao-result
        [planName]="planName()"
        [planId]="data?.planId || 0"
        [gangId]="data?.gangId || null"
        [statistics]="getLocaoStatistics()"
        [productTotals]="productTotals"
        [mixRows]="getMixRowsForStatistics()"
        [processParams]="getProcessParamsForStatistics()"
      />
    </section>
    <!-- Bảng chi phí theo tỷ lệ (triển khai theo yêu cầu mới) -->
    <div
      class="section-table-tmp"
      *ngIf="rows().length > 0 && milestone() === MilestoneEnum.ThieuKet"
    >
      <h3 class="section-table-tmp-title">
        <mat-icon>attach_money</mat-icon>
        Bảng chi phí (Thiêu Kết)
      </h3>
      <table class="mix-table">
        <thead>
          <tr>
            <th class="stub">Quặng</th>
            <th class="text-right">Tiêu hao (tấn/tsp)</th>
            <th class="text-right">Đơn giá (VND/tấn)</th>
            <th class="text-right">Đơn giá (USD/tấn)</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let i of getCostTableItems()"
            [class.parent-ore]="i.isParent"
            [class.loai-7]="i.loaiQuang === LoaiQuangEnum.QuangPA && i.isParent"
          >
            <td class="stub">{{ i.ten }}</td>
            <td class="text-right">{{ formatDynamic(i.consumption) }}</td>
            <td class="text-right">{{ formatDynamic(i.unitVnd) }}</td>
            <td class="text-right">{{ formatDynamic(i.unitUsd) }}</td>
          </tr>
          <!-- Dòng chi phí khác -->
          <tr class="other-cost-row">
            <td class="stub">Chi phí khác</td>
            <td class="text-right">1</td>
            <td class="text-right">
              <input
                type="text"
                inputmode="decimal"
                class="cost-input"
                [(ngModel)]="otherCost"
                (ngModelChange)="onOtherCostChange()"
                placeholder="0.00"
              />
            </td>
            <td class="text-right">-</td>
          </tr>
          <!-- Dòng tổng -->
          <tr class="total-row">
            <th class="stub">Tổng</th>
            <td class="text-right">
            </td>
            <td class="text-right">
              {{ formatDynamic(getTotalAllCosts()) }}
            </td>
            <td class="text-right">
              {{ formatDynamic(getTotalAllCostsUSD()) }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Bảng chi phí riêng cho milestone Lò cao (placeholder, sẽ tính công thức sau) -->
    <div
      class="section-table-tmp"
      *ngIf="rows().length > 0 && milestone() === MilestoneEnum.LoCao"
    >
      <h3 class="section-table-tmp-title">
        <mat-icon>attach_money</mat-icon>
        Bảng chi phí (Lò cao)
      </h3>
      <table class="mix-table">
        <thead>
          <tr>
            <th class="stub">Quặng</th>
            <th class="text-right">Tiêu hao (tấn/tsp)</th>
            <th class="text-right">Đơn giá (VND/tấn)</th>
            <th class="text-right">Đơn giá (USD/tấn)</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of rows()" [class.loai-7]="r.loaiQuang === LoaiQuangEnum.QuangPA">
            <td class="stub">{{ r.tenQuang }}</td>
            <td class="text-right">
              {{ formatDynamic(getLoCaoConsumption(r)) }}
            </td>
            <td class="text-right">
              {{ formatDynamic(getUnitPriceVND(r)) }}
            </td>
            <td class="text-right">
              {{ formatDynamic(getUnitPriceUSD(r)) }}
            </td>
          </tr>
          <!-- Dòng chi phí sản xuất khác (nhập tay) -->
          <tr class="other-cost-row">
            <td class="stub">Chi phí sản xuất gang lỏng</td>
            <td class="text-right">1</td>
            <td class="text-right">
              <input
                type="text"
                inputmode="decimal"
                class="cost-input"
                [(ngModel)]="otherCostLoCao"
                (ngModelChange)="onOtherCostLocaoChange()"
                placeholder="0.00"
              />
            </td>
            <td class="text-right">-</td>
          </tr>
          <!-- Dòng quặng hồi -->
          <tr>
            <td class="stub">Quặng hồi</td>
            <td class="text-right">
              {{ formatDynamic(getLoCaoRecycleConsumption()) }}
            </td>
            <td class="text-right">
              <input
                type="text"
                inputmode="decimal"
                class="cost-input"
                [(ngModel)]="recycleCostVnd"
                (ngModelChange)="onRecycleCostVndChange()"
                placeholder="0.00"
              />
            </td>
            <td class="text-right"></td>
          </tr>
          <!-- Dòng tổng -->
          <tr class="total-row">
            <th class="stub">Tổng</th>
            <td class="text-right">
            </td>
            <td class="text-right">
              {{ formatDynamic(getTotalLoCaoCost()) }}
            </td>
            <td class="text-right">
              {{ formatDynamic(getTotalLoCaoCostUSD()) }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-stroked-button (click)="cancel()">Huỷ</button>
  <button
    mat-flat-button
    color="primary"
    (click)="submit()"
    [disabled]="isSubmitDisabled"
    [matTooltip]="isSubmitDisabled ? 'Vui lòng kiểm tra lại thông tin' : ''"
  >
    Lưu
  </button>
</mat-dialog-actions>
