<!-- <h2 mat-dialog-title>Phối trộn quặng</h2> -->

<mat-dialog-content class="content">
  <!-- Header: Thông tin công thức (ẩn riêng gang/plan nếu không có) -->
  <section class="section header-info">
    <h4 class="section-title">Thông tin tổng hợp</h4>
    <div class="info-card">
      <div
        class="info-row"
        *ngIf="(data?.gangId && gangName()) || (data?.planId && planName())"
      >
        <div class="info-item">
          <span class="info-label">Quặng gang đích:</span>
          <span class="info-value">{{ gangName() }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Phương án:</span>
          <span class="info-value">{{ planName() }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Ngày tạo:</span>
          <span class="info-value">{{
            data?.planNgayTao
              ? (data!.planNgayTao | date : "dd/MM/yyyy")
              : (today() | date : "dd/MM/yyyy")
          }}</span>
        </div>
      </div>
      <div class="info-row">
        <div class="info-item">
          <span class="info-label">Mã công thức:</span>
          <span class="info-value">{{
            maCongThucCtrl.value || "Chưa nhập mã quặng"
          }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Tên công thức:</span>
          <span class="info-value">{{
            tenCongThucCtrl.value || "Chưa nhập tên quặng"
          }}</span>
        </div>
        <div class="info-item">
          <!-- Empty space for alignment -->
        </div>
      </div>
    </div>
  </section>

  <!-- Thông tin quặng mới tạo từ kết quả phối -->
  <section class="section">
    <h4 class="section-title">Thông tin quặng mới</h4>
    <div
      class="grid"
      [ngStyle]="{
        'grid-template-columns': data?.planId
          ? 'repeat(4, 1fr)'
          : 'repeat(3, 1fr)'
      }"
    >
      <mat-form-field appearance="outline" class="dialog-input">
        <mat-label>Mã quặng</mat-label>
        <input
          matInput
          [formControl]="oreForm.controls.MaQuang"
          placeholder="VD: {{
            (data?.maGang || 'GANG') + '-' + (data?.planName || 'PA')
          }}"
        />
      </mat-form-field>
      <mat-form-field appearance="outline" class="dialog-input">
        <mat-label>Tên quặng</mat-label>
        <input
          matInput
          [formControl]="oreForm.controls.TenQuang"
          placeholder="VD: Quặng phối {{ data?.planName || '' }}"
        />
      </mat-form-field>
      <ng-container *ngIf="data?.planId; else noMilestone">
        <mat-form-field appearance="outline" class="dialog-input">
          <mat-label>Milestone</mat-label>
          <mat-select
            [value]="milestone()"
            (selectionChange)="milestone.set($event.value)"
          >
            <mat-option [value]="MilestoneEnum.Standard"
              >--- Chọn Milestone ---</mat-option
            >
            <mat-option [value]="MilestoneEnum.ThieuKet">Thiêu kết</mat-option>
            <mat-option [value]="MilestoneEnum.LoCao">Lò cao</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="dialog-input">
          <mat-label>Ngày tạo quặng</mat-label>
          <input
            matInput
            [matDatepicker]="pickerPlan"
            [formControl]="oreForm.controls.NgayTao"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="pickerPlan"
          ></mat-datepicker-toggle>
          <mat-datepicker #pickerPlan></mat-datepicker>
        </mat-form-field>
      </ng-container>
      <ng-template #noMilestone>
        <mat-form-field appearance="outline" class="dialog-input">
          <mat-label>Ngày tạo quặng</mat-label>
          <input
            matInput
            [matDatepicker]="pickerStd"
            [formControl]="oreForm.controls.NgayTao"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="pickerStd"
          ></mat-datepicker-toggle>
          <mat-datepicker #pickerStd></mat-datepicker>
        </mat-form-field>
      </ng-template>
    </div>
    <div class="grid">
      <mat-form-field appearance="outline" class="dialog-input col-span-3">
        <mat-label>Ghi chú</mat-label>
        <input matInput [formControl]="oreForm.controls.GhiChu" />
      </mat-form-field>
    </div>
  </section>

  <!-- Chọn TPHH + nhập min/max -->
  <section class="section">
    <div class="section-header">
      <h3 class="section-title">Thành phần hoá học</h3>
      <button mat-stroked-button color="primary" (click)="openSelectChems()">
        <mat-icon>category</mat-icon>&nbsp;Chọn TPHH
      </button>
    </div>

    <div class="constraints" *ngIf="selectedChems().length > 0">
      <table class="constraints-table">
        <thead>
          <tr>
            <th class="stub">Ràng buộc</th>
            <th
              *ngFor="let c of selectedChems(); trackBy: trackChem"
              class="chem-col"
            >
              <div class="th-wrap">
                <span class="th-text" [title]="c.ma_TPHH">{{ c.ma_TPHH }}</span>
                <button
                  type="button"
                  class="remove-btn"
                  (click)="removeChem(c.id)"
                  matTooltip="Xóa TPHH này"
                  matTooltipPosition="above"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <th class="stub">Min (%)</th>
            <td *ngFor="let c of selectedChems(); trackBy: trackChem">
              <input
                type="number"
                min="0"
                step="0.01"
                class="cell-input text-right"
                [formControl]="getConstraintCtrl(c.id, 'min')"
              />
            </td>
          </tr>

          <tr>
            <th class="stub">Max (%)</th>
            <td *ngFor="let c of selectedChems(); trackBy: trackChem">
              <input
                type="number"
                min="0"
                step="0.01"
                class="cell-input text-right"
                [formControl]="getConstraintCtrl(c.id, 'max')"
              />
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Chọn quặng & Bảng phối -->
  <section class="section">
    <div class="section-header">
      <h3 class="section-title">Chọn quặng nguồn & nhập tỉ lệ phối</h3>
      <button
        mat-stroked-button
        color="primary"
        (click)="openSelectOres()"
        [disabled]="selectedChems().length === 0"
      >
        <mat-icon>inventory_2</mat-icon>&nbsp;Chọn quặng
      </button>
    </div>
    <div class="section-table-tmp">
      <!-- <h3 class="section-table-tmp-title">Bảng phụ</h3> -->
      <!-- Conditional rendering based on milestone -->
      @switch (milestone()) { @case (MilestoneEnum.LoCao) {
      <app-mix-quang-locao-section
        [selectedChems]="selectedChems()"
        [locaoControls]="locaoControls()"
        [updateTrigger]="updateTrigger()"
        [planId]="data?.planId || 0"
        (processParamsChange)="onProcessParamsChange($event)"
      />
      } @default {
      <!-- Default content for other milestones -->
      } }
    </div>
    <div
      class="table-wrap"
      *ngIf="rows().length > 0 && selectedChems().length > 0"
    >
      <table class="mix-table">
        <thead>
          <tr>
            <th class="stub" rowspan="2">Quặng</th>
            <th class="group" colspan="1">Cột nhập tỉ lệ phối</th>
            <th
              class="group"
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              colspan="2"
            >
              Thiêu kết khấu hao
            </th>
            <th
              class="group"
              *ngIf="milestone() === MilestoneEnum.LoCao"
              colspan="3"
            >
              Thông tin phối
            </th>
            <th
              class="group"
              [attr.colspan]="
                milestone() === MilestoneEnum.ThieuKet
                  ? displayedColumns().length - 3
                  : milestone() === MilestoneEnum.LoCao
                  ? displayedColumns().length - 3
                  : displayedColumns().length - 11
              "
            >
              Các thành phần hóa học
            </th>
          </tr>
          <tr>
            <th class="ratio-col">Tỷ lệ, %</th>
            <th
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              class="thieu-ket-col"
            >
              Khấu hao
            </th>
            <th
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              class="percentage-col"
            >
              Tỷ lệ khấu hao
            </th>
            <th
              *ngIf="milestone() === MilestoneEnum.LoCao"
              class="kl-vao-lo-col"
            >
              KL vào lò
            </th>
            <th
              *ngIf="milestone() === MilestoneEnum.LoCao"
              class="ty-le-hoi-quang-col"
            >
              Tỷ lệ hồi quặng
            </th>
            <th *ngIf="milestone() === MilestoneEnum.LoCao" class="kl-nhan-col">
              KL nhận
            </th>
            <th *ngFor="let c of selectedChems()">{{ c.ma_TPHH }}</th>
          </tr>
        </thead>

        <tbody>
          <!-- Hàng quặng nguồn -->
          <tr
            *ngFor="let r of rows(); let i = index"
            [class.mixed-ore-row]="r.loaiQuang === 1"
          >
            <th class="stub">
              <div class="ore-cell">
                <button
                  type="button"
                  class="remove-btn"
                  (click)="removeRow(r)"
                  matTooltip="Xóa quặng này"
                  matTooltipPosition="above"
                >
                  <mat-icon>close</mat-icon>
                </button>
                <div class="ore-name" [title]="r.tenQuang">
                  {{ r.tenQuang }}
                </div>
              </div>
            </th>

            <!-- tỷ lệ phối -->
            <td class="ratio-cell">
              <input
                type="number"
                min="0"
                step="0.01"
                class="cell-input text-center"
                [formControl]="r.ratioCtrl"
              />
            </td>

            <!-- Thiêu kết khấu hao -->
            <td
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              class="thieu-ket-cell text-right"
            >
              <span *ngIf="getThieuKetKhauHaoValue(r) !== 0">{{
                getThieuKetKhauHaoValue(r) | number : "1.2-2"
              }}</span>
            </td>

            <!-- Thiêu kết: Tỷ lệ khấu hao (%) -->
            <td
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              class="percentage-cell text-right"
            >
              <span *ngIf="getThieuKetKhauHaoPercentage(r) !== 0">{{
                getThieuKetKhauHaoPercentage(r) | number : "1.3-3"
              }}</span>
            </td>

            <!-- Lò cao: KL vào lò -->
            <td
              *ngIf="milestone() === MilestoneEnum.LoCao"
              class="kl-vao-lo-cell"
            >
              <span
                *ngIf="
                  isLocaoKlVaoLoCalculated(r) && getLocaoKlVaoLoValue(r) !== 0
                "
                class="calculated-value"
                >{{ getLocaoKlVaoLoValue(r) | number : "1.2-2" }}</span
              >
              <input
                *ngIf="!isLocaoKlVaoLoCalculated(r)"
                type="number"
                min="0"
                step="0.01"
                class="cell-input text-center"
                [formControl]="r.klVaoLoCtrl"
                hideZeroInput
              />
            </td>

            <!-- Lò cao: Tỷ lệ hồi quặng -->
            <td
              *ngIf="milestone() === MilestoneEnum.LoCao"
              class="ty-le-hoi-quang-cell"
            >
              <input
                *ngIf="r.loaiQuang !== 3"
                type="number"
                min="0"
                max="100"
                step="0.1"
                class="cell-input text-center"
                [formControl]="r.tyLeHoiQuangCtrl"
                placeholder="%"
              />
            </td>

            <!-- Lò cao: KL nhận -->
            <td
              *ngIf="milestone() === MilestoneEnum.LoCao"
              class="kl-nhan-cell"
            >
              <span class="calculated-value text-center">{{
                r.klNhanCtrl.value | number : "1.2-2"
              }}</span>
            </td>

            <!-- các thành phần hoá học -->
            <td *ngFor="let c of selectedChems()">
              <input
                type="number"
                step="0.001"
                class="cell-input text-right"
                [formControl]="getChemCtrl(r, c.id)"
                hideZeroInput
              />
            </td>
          </tr>

          <!-- Dòng tổng & kết quả sau tính -->
          <tr *ngIf="milestone() !== MilestoneEnum.ThieuKet" class="result-row">
            <th class="stub">Tổng</th>
            <td class="text-center">{{ totalRatio() | number : "1.0-1" }}%</td>
            <td
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              class="text-right"
            >
              {{ getTotalThieuKetKhauHao() | number : "1.2-2" }}
            </td>
            <td
              *ngIf="milestone() === MilestoneEnum.ThieuKet"
              class="text-right"
            >
              {{ getTotalThieuKetKhauHaoPercentage() | number : "1.3-3" }}
            </td>
            <!-- Các cột tổng cho milestone Lò Cao -->
            <td *ngIf="milestone() === MilestoneEnum.LoCao" class="text-right">
              {{ getTotalLocaoKlVaoLo() | number : "1.2-2" }}
            </td>
            <td *ngIf="milestone() === MilestoneEnum.LoCao" class="text-right">
              {{ getTotalLocaoTyLeHoiQuang() | number : "1.2-2" }}%
            </td>
            <td *ngIf="milestone() === MilestoneEnum.LoCao" class="text-right">
              {{ getTotalLocaoKlNhan() | number : "1.2-2" }}
            </td>
            <td
              *ngFor="let c of selectedChems()"
              class="text-right"
              [class.out-range]="isOutOfRange(c.id)"
            >
              <span
                *ngIf="milestone() === MilestoneEnum.LoCao; else defaultTotal"
              >
                {{ getChemTotalBySumProduct(c.id) | number : "1.2-2" }}
              </span>
              <ng-template #defaultTotal>
                {{ resultRow()[c.id] | number : "1.0-2" }}
              </ng-template>
            </td>
          </tr>

          <!-- Dòng Result 1 cho milestone ThieuKet: tỷ lệ x hàm lượng TPHH -->
          <tr *ngIf="milestone() === MilestoneEnum.ThieuKet" class="result-row">
            <th class="stub"></th>
            <td class="text-center">{{ totalRatio() | number : "1.0-1" }}%</td>
            <td class="text-right">
              {{ getTotalThieuKetKhauHao() | number : "1.2-2" }}
            </td>
            <td class="text-right">
              {{ getTotalThieuKetKhauHaoPercentage() | number : "1.3-3" }}
            </td>
            <td *ngFor="let c of selectedChems()" class="text-right">
              <span *ngIf="!shouldHideInResult1(c.id)">
                {{ getThieuKetRow1Value(c.id) | number : "1.2-2" }}
              </span>
              <span *ngIf="shouldHideInResult1(c.id)"><strong>R2</strong></span>
            </td>
          </tr>

          <!-- Dòng Result 2 cho milestone ThieuKet: Result 1 / tổng khấu hao -->
          <tr *ngIf="milestone() === MilestoneEnum.ThieuKet" class="result-row">
            <th class="stub">Tổng</th>
            <td class="text-center">-</td>
            <td class="text-right">-</td>
            <td class="text-right">-</td>
            <td
              *ngFor="let c of selectedChems()"
              class="text-right"
              [class.out-range]="isOutOfRange(c.id)"
            >
              <span *ngIf="c.ma_TPHH === 'MKN'">
                {{ getThieuKetCaOSiO2Ratio() | number : "1.3-3" }}
              </span>
              <span *ngIf="c.ma_TPHH !== 'MKN'">
                {{ getThieuKetRow2Value(c.id) | number : "1.3-3" }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- Locao Results Component - Hiển thị dưới bảng mix quặng -->
    <section
      class="locao-results-section"
      *ngIf="milestone() === MilestoneEnum.LoCao"
    >
      <app-locao-result
        [planName]="planName()"
        [planId]="data?.planId || 0"
        [gangId]="data?.gangId || null"
        [statistics]="getLocaoStatistics()"
        [productTotals]="productTotals"
        [mixRows]="getMixRowsForStatistics()"
        [processParams]="getProcessParamsForStatistics()"
      />
    </section>
    <!-- Bảng chi phí theo tỷ lệ (triển khai theo yêu cầu mới) -->
    <div
      class="section-table-tmp"
      *ngIf="rows().length > 0 && milestone() === MilestoneEnum.ThieuKet"
    >
      <h3 class="section-table-tmp-title">Bảng chi phí</h3>
      <table class="mix-table">
        <thead>
          <tr>
            <th class="stub">Quặng</th>
            <th class="text-right">Tiêu hao (tấn/tsp)</th>
            <th class="text-right">Đơn giá (VND/tấn)</th>
            <th class="text-right">Đơn giá (USD/tấn)</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let i of getCostTableItems()"
            [class.parent-ore]="i.isParent"
          >
            <td class="stub">{{ i.ten }}</td>
            <td class="text-right">{{ i.consumption | number : "1.3-3" }}</td>
            <td class="text-right">{{ i.unitVnd | number : "1.2-2" }}</td>
            <td class="text-right">{{ i.unitUsd | number : "1.2-2" }}</td>
          </tr>
          <!-- Dòng chi phí khác -->
          <tr class="other-cost-row">
            <td class="stub">Chi phí khác</td>
            <td class="text-right">-</td>
            <td class="text-right">
              <input
                type="number"
                class="cost-input"
                [(ngModel)]="otherCost"
                (ngModelChange)="onOtherCostChange()"
                step="0.01"
                min="0"
                placeholder="0.00"
              />
            </td>
            <td class="text-right">-</td>
          </tr>
          <!-- Dòng tổng -->
          <tr class="total-row">
            <th class="stub">Tổng</th>
            <td class="text-right">
              {{ getTotalConsumption() | number : "1.3-3" }}
            </td>
            <td class="text-right">
              {{ getTotalAllCosts() | number : "1.2-2" }}
            </td>
            <td class="text-right">
              {{ getTotalAllCostsUSD() | number : "1.2-2" }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Bảng chi phí riêng cho milestone Lò cao (placeholder, sẽ tính công thức sau) -->
    <div
      class="section-table-tmp"
      *ngIf="rows().length > 0 && milestone() === MilestoneEnum.LoCao"
    >
      <h3 class="section-table-tmp-title">Bảng chi phí (Lò cao)</h3>
      <table class="mix-table">
        <thead>
          <tr>
            <th class="stub">Quặng</th>
            <th class="text-right">Tiêu hao (tấn/tsp)</th>
            <th class="text-right">Đơn giá (VND/tấn)</th>
            <th class="text-right">Đơn giá (USD/tấn)</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of rows()">
            <td class="stub">{{ r.tenQuang }}</td>
            <td class="text-right">
              {{ getLoCaoConsumption(r) | number : "1.3-3" }}
            </td>
            <td class="text-right">
              {{ getUnitPriceVND(r) | number : "1.2-2" }}
            </td>
            <td class="text-right">
              {{ getUnitPriceUSD(r) | number : "1.2-2" }}
            </td>
          </tr>
          <!-- Dòng chi phí sản xuất khác (nhập tay) -->
          <tr class="other-cost-row">
            <td class="stub">Chi phí sản xuất khác</td>
            <td class="text-right">-</td>
            <td class="text-right">
              <input
                type="number"
                class="cost-input"
                [(ngModel)]="otherCostLoCao"
                (ngModelChange)="onOtherCostLocaoChange()"
                step="0.01"
                min="0"
                placeholder="0.00"
              />
            </td>
            <td class="text-right">-</td>
          </tr>
          <!-- Dòng quặng hồi -->
          <tr>
            <td class="stub">Quặng hồi</td>
            <td class="text-right">
              {{ getLoCaoRecycleConsumption() | number : "1.3-3" }}
            </td>
            <td class="text-right">-</td>
            <td class="text-right">-</td>
          </tr>
          <!-- Dòng tổng -->
          <tr class="total-row">
            <th class="stub">Tổng</th>
            <td class="text-right">
              {{ getTotalLoCaoConsumption() | number : "1.3-3" }}
            </td>
            <td class="text-right">
              {{ getTotalLoCaoCost() | number : "1.2-2" }}
            </td>
            <td class="text-right">
              {{ getTotalLoCaoCostUSD() | number : "1.2-2" }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-stroked-button (click)="cancel()">Huỷ</button>
  <button
    mat-flat-button
    color="primary"
    (click)="submit()"
    [disabled]="isSubmitDisabled"
    [matTooltip]="isSubmitDisabled ? 'Vui lòng kiểm tra lại thông tin' : ''"
  >
    Lưu
  </button>
</mat-dialog-actions>
