<h2 mat-dialog-title>{{ (mode==='MUA' ? 'Thêm quặng mua' : 'Sửa quặng') }}</h2>

<div mat-dialog-content class="dialog-body">
  <!-- Loading state for data fetching -->
  <div class="loading-overlay" *ngIf="loading()">
    <div class="loading-content">
      <mat-icon class="spinning">refresh</mat-icon>
      <span>Đang tải dữ liệu...</span>
    </div>
  </div>
  
  <!-- Error state -->
  <div class="error-message" *ngIf="error() && !loading()">
    <mat-icon>error</mat-icon>
    <span>{{ error() }}</span>
  </div>
  <!-- Header form -->
  <div class="grid">
    <mat-form-field appearance="outline" class="span-2">
      <mat-label>Tên quặng *</mat-label>
      <input matInput [formControl]="headerForm.controls.tenQuang" />
      <mat-error *ngIf="headerForm.controls.tenQuang.invalid && headerForm.controls.tenQuang.touched">
        Tên quặng là bắt buộc
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="span-2">
      <mat-label>Mã quặng *</mat-label>
      <input matInput [formControl]="headerForm.controls.maQuang" placeholder="Tự động tạo từ tên quặng" readonly />
      <mat-error *ngIf="headerForm.controls.maQuang.invalid && headerForm.controls.maQuang.touched">
        Mã quặng là bắt buộc
      </mat-error>
    </mat-form-field>

    
    <mat-form-field appearance="outline" class="span-2">
        <mat-label>Loại quặng *</mat-label>
        <mat-select [formControl]="headerForm.controls.loaiQuang" >
          <mat-option [value]="0">Quặng thường</mat-option>
          <mat-option [value]="3">Quặng phụ liệu (Coke, than phun...)</mat-option>
          <mat-option [value]="5">Quặng cỡ</mat-option>
        </mat-select>
    </mat-form-field>

    <!-- Nút check tồn tại - tạm thời ẩn -->
    <!-- <div class="span-all check-button-container">
      <button 
        mat-raised-button 
        color="primary" 
        (click)="onCheckExists()" 
        [disabled]="checking() || !headerForm.controls.maQuang.value?.trim() || !headerForm.controls.tenQuang.value?.trim() || !!(canEditOtherFields() && data.quang?.id)"
        [class.loading]="checking()">
        <mat-icon *ngIf="!checking()">check_circle</mat-icon>
        <mat-icon *ngIf="checking()" class="spinning">refresh</mat-icon>
        {{ checking() ? 'Đang kiểm tra...' : 'Kiểm tra tồn tại' }}
      </button>
      <div class="check-status" *ngIf="checkError()">
        <mat-icon color="warn">error</mat-icon>
        <span class="error-text">{{ checkError() }}</span>
      </div>
      <div class="check-status success" *ngIf="isChecked() && !checkError()">
        <mat-icon color="primary">check_circle</mat-icon>
        <span class="success-text">Mã và tên quặng hợp lệ</span>
      </div>
    </div> -->
    
    <!-- Pricing Section riêng 1 hàng -->
    <div class="pricing-section span-all" >
      <div class="pricing-content">
        <mat-form-field appearance="outline" class="price-input">
          <mat-label>Giá USD/tấn</mat-label>
          <input matInput type="text" inputmode="decimal" step="0.01" [formControl]="headerForm.controls.giaUSD" />
        </mat-form-field>

        <div class="rate-info">
          <div class="rate-header">
            <span class="rate-label">Tỷ giá</span>
            <input type="date" class="rate-date" [formControl]="dateCtrl" [attr.max]="maxDate"  />
          </div>
          
          <div class="rate-display">
            <div class="rate-value" *ngIf="rate() !== null && !loading()">
              <span class="currency">1 USD</span>
              <span class="equals">=</span>
              <span class="amount">{{ rate()! | currency:'VND':'symbol':'1.2-2':'vi-VN' }}</span>
            </div>
            
            <div class="rate-loading" *ngIf="loading()">
              <mat-icon class="spinning">refresh</mat-icon>
              <span>Đang tải...</span>
            </div>
            
            <div class="rate-error" *ngIf="error()">
              <mat-icon>error</mat-icon>
              <span>{{ error() }}</span>
            </div>
          </div>
          
          <div class="converted-price" *ngIf="(valueConvertToVnd() !== null) && !loading()">
            <span class="label">Giá VND:</span>
            <span class="value">{{ (valueConvertToVnd()) | currency:'VND':'symbol':'1.2-2':'vi-VN' }}</span>
          </div>
        </div>
      </div>
    </div>

    

    <mat-form-field appearance="outline" class="span-all">
      <mat-label>Ghi chú</mat-label>
      <textarea matInput rows="2" [formControl]="headerForm.controls.ghiChu" ></textarea>
    </mat-form-field>

    
  </div>

  <!-- MUA -->
  <ng-container>
    <section class="section">
    <div class="section-header">
      <h3 class="section-title">Thành phần hoá học</h3>
      <button mat-stroked-button color="primary" (click)="openSelectChems()" >
        <mat-icon>category</mat-icon>&nbsp;Chọn TPHH
      </button>
    </div>

    <div class="constraints" *ngIf="selectedChems().length > 0">
      <table class="constraints-table">
        <thead>
          <tr>
            <th class="stub">TPHH</th>
            <th
              *ngFor="let c of selectedChems()"
              class="chem-col"
            >
              <div class="th-wrap">
                <span class="th-text" [title]="c.ten_TPHH">{{
                  c.ma_TPHH
                }}</span>
                <button 
                  type="button" 
                  class="remove-btn" 
                  (click)="removeChem(c.id)"
                  matTooltip="Xóa quặng này"
                  matTooltipPosition="above">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <th class="stub">Hàm lượng</th>
            <td *ngFor="let c of selectedChems(); trackBy: trackByChem">
              <ng-container *ngIf="tp_HoaHocs().get(c.id) as ctrl">
                <input
                  type="number"
                  min="0"
                  step="0.0001"
                  inputmode="decimal"
                  class="cell-input text-right"
                  [formControl]="ctrl.phanTram"
                  [disabled]="!canEditOtherFields()"
                />
              </ng-container>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
  </ng-container>
</div>

<div mat-dialog-actions align="end">
  <button mat-stroked-button (click)="onCancel()">Huỷ</button>
  <button mat-flat-button color="primary"
          (click)="onSave()">
    Lưu
  </button>
</div>
