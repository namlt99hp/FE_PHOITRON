<h2 mat-dialog-title>{{ (mode==='MUA' ? 'Thêm quặng mua' : 'Sửa quặng') }}</h2>

<div mat-dialog-content class="dialog-body">
  <!-- Loading state for data fetching -->
  <div class="loading-overlay" *ngIf="loading()">
    <div class="loading-content">
      <mat-icon class="spinning">refresh</mat-icon>
      <span>Đang tải dữ liệu...</span>
    </div>
  </div>
  
  <!-- Error state -->
  <div class="error-message" *ngIf="error() && !loading()">
    <mat-icon>error</mat-icon>
    <span>{{ error() }}</span>
  </div>
  <!-- Header form -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Tên quặng *</mat-label>
        <input matInput [formControl]="headerForm.controls.tenQuang" />
        <mat-error *ngIf="headerForm.controls.tenQuang.invalid && headerForm.controls.tenQuang.touched">
          Tên quặng là bắt buộc
        </mat-error>
      </mat-form-field>
    </div>

    <div class="col-md-3">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Mã quặng *</mat-label>
        <input matInput [formControl]="headerForm.controls.maQuang" placeholder="Tự động tạo từ tên quặng" readonly />
        <mat-error *ngIf="headerForm.controls.maQuang.invalid && headerForm.controls.maQuang.touched">
          Mã quặng là bắt buộc
        </mat-error>
      </mat-form-field>
    </div>

    <div class="col-md-3">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Loại quặng *</mat-label>
        <mat-select [formControl]="headerForm.controls.idLoaiQuang">
          <mat-option *ngFor="let lq of loaiQuangs" [value]="lq.id">
            {{ lq.tenLoaiQuang }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="headerForm.controls.idLoaiQuang.invalid && headerForm.controls.idLoaiQuang.touched">
          Loại quặng là bắt buộc
        </mat-error>
      </mat-form-field>
    </div>

    <div class="col-md-3">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Lô quặng</mat-label>
        <input
          matInput
          type="text"
          [formControl]="loQuangSearchCtrl"
          [matAutocomplete]="loQuangAuto"
          (input)="onLoQuangInputChange($any($event.target).value)"
          placeholder="Nhập hoặc chọn lô quặng"
        />
        <mat-autocomplete
          #loQuangAuto="matAutocomplete"
          [displayWith]="displayLoQuang"
          (optionSelected)="onLoQuangSelected($event.option.value)"
        >
          <mat-option *ngFor="let lo of filteredLoQuangs()" [value]="lo">
            {{ lo.maLoQuang }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </div>

    
    
    <!-- Pricing Section riêng 1 hàng -->
    <div class="pricing-section span-all" >
      <div class="pricing-content">
        <mat-form-field appearance="outline" class="price-input">
          <mat-label>Giá USD/tấn</mat-label>
          <input matInput type="text" inputmode="decimal" step="0.01" [formControl]="headerForm.controls.giaUSD" />
        </mat-form-field>

        <div class="rate-info">
          <div class="rate-header">
            <span class="rate-label">Tỷ giá</span>
            <input type="date" class="rate-date" [formControl]="dateCtrl" [attr.max]="maxDate"  />
          </div>
          
          <div class="rate-display">
            <div class="rate-value" *ngIf="rate() !== null && !loading()">
              <span class="currency">1 USD</span>
              <span class="equals">=</span>
              <span class="amount">{{ rate()! | currency:'VND':'symbol':'1.2-2':'vi-VN' }}</span>
            </div>
            
            <div class="rate-loading" *ngIf="loading()">
              <mat-icon class="spinning">refresh</mat-icon>
              <span>Đang tải...</span>
            </div>
            
            <div class="rate-error" *ngIf="error()">
              <mat-icon>error</mat-icon>
              <span>{{ error() }}</span>
            </div>
          </div>
          
          <div class="converted-price" *ngIf="(valueConvertToVnd() !== null) && !loading()">
            <span class="label">Giá VND:</span>
            <span class="value">{{ (valueConvertToVnd()) | currency:'VND':'symbol':'1.2-2':'vi-VN' }}</span>
          </div>
        </div>
      </div>
    </div>

    

    <mat-form-field appearance="outline" class="span-all">
      <mat-label>Ghi chú</mat-label>
      <textarea matInput rows="2" [formControl]="headerForm.controls.ghiChu" ></textarea>
    </mat-form-field>

    
  </div>

  <!-- MUA -->
  <ng-container>
    <section class="section">
    <div class="section-header">
      <h3 class="section-title">Thành phần hoá học</h3>
      <button mat-stroked-button color="primary" (click)="openSelectChems()" >
        <mat-icon>category</mat-icon>&nbsp;Chọn TPHH
      </button>
    </div>

    <div class="constraints" *ngIf="selectedChems().length > 0">
      <table class="constraints-table">
        <thead>
          <tr>
            <th class="stub">TPHH</th>
            <th
              *ngFor="let c of selectedChems()"
              class="chem-col"
            >
              <div class="th-wrap">
                <span class="th-text" [title]="c.ten_TPHH">{{
                  c.ma_TPHH
                }}</span>
                <button 
                  type="button" 
                  class="remove-btn" 
                  (click)="removeChem(c.id)"
                  matTooltip="Xóa quặng này"
                  matTooltipPosition="above">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <th class="stub">Hàm lượng</th>
            <td *ngFor="let c of selectedChems(); trackBy: trackByChem">
              <ng-container *ngIf="tp_HoaHocs().get(c.id) as ctrl">
                <input
                  type="number"
                  min="0"
                  step="0.0001"
                  inputmode="decimal"
                  class="cell-input text-right"
                  [formControl]="ctrl.phanTram"
                  [disabled]="!canEditOtherFields()"
                />
              </ng-container>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
  </ng-container>
</div>

<div mat-dialog-actions align="end">
  <button mat-stroked-button (click)="onCancel()">Huỷ</button>
  <button mat-flat-button color="primary"
          (click)="onSave()">
    Lưu
  </button>
</div>
