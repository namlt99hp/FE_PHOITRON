<div class="plan-tab">
  <!-- Compact Header -->
  <div class="header">
    <div class="header-main">
      <div class="plan-info">
        <h2 class="plan-title">{{ plan.ten }}</h2>
        
      </div>
      
      <div class="function-buttons">
        <button mat-stroked-button (click)="onCreateGang()" class="action-btn" matTooltip="Cấu hình gang kết quả">
          <mat-icon>build</mat-icon>
          {{ gangKetQuaId ? 'Sửa gang' : 'Tạo gang' }}
        </button>
        <button mat-stroked-button (click)="onCreateSlag()" class="action-btn" matTooltip="Cấu hình xỉ kết quả">
          <mat-icon>science</mat-icon>
          {{ slagId ? 'Sửa xỉ' : 'Tạo xỉ' }}
        </button>
        <button mat-stroked-button (click)="openProcessParamConfig()" class="action-btn" matTooltip="Cấu hình lò cao phụ tải">
          <mat-icon>settings</mat-icon>
          Tham số
        </button>
        <button mat-stroked-button (click)="openStatisticsConfig()" class="action-btn" matTooltip="Cấu hình thống kê">
          <mat-icon>analytics</mat-icon>
          Thống kê
        </button>
        <button mat-flat-button 
                color="primary" 
                (click)="openMixDialog()" 
                class="mix-btn"
                [disabled]="hasLoCaoMilestone()"
                [matTooltip]="hasLoCaoMilestone() ? 'Không thể phối trộn thêm vì đã có milestone Lò Cao (cấp cao nhất)' : 'Phối trộn quặng'">
          <mat-icon>shuffle</mat-icon>
          Phối trộn
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content">
    <!-- Simplified Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h3>Luồng phối</h3>
      </div>
      <div class="milestone-list">
        <div *ngFor="let m of mixes()" 
             class="milestone-item clickable" 
             (click)="scrollToMix(m.id)" 
             [title]="m.ten">
          <div class="milestone-dot"></div>
          <span class="milestone-name">{{ m.ten }}</span>
        </div>
      </div>
    </aside>
    
    <!-- Main Content Area -->
    <main class="main-content">
      <div class="content-header">
        <h3>Công thức phối</h3>
        <div class="content-meta">{{ congThucDetails().length }} công thức</div>
      </div>

      <div class="mix-sections">
        <div *ngIf="isLoading()" class="loading-message">
          Đang tải danh sách công thức phối...
        </div>
        
        <div *ngFor="let detail of congThucDetails()" 
             class="formula-card" 
             [attr.id]="mixAnchorId(detail.id)" 
             [ngClass]="getMilestoneClass(detail.milestone)">
          <div class="formula-header">
            <div class="formula-info">
              <h4 class="formula-title">{{ detail.ten_Cong_Thuc || detail.ma_Cong_Thuc }}</h4>
              <div class="formula-tags">
                <span class="tag">{{ detail.ma_Cong_Thuc }}</span>
                <span class="tag milestone">{{ getMilestoneDisplayName(detail.milestone) }}</span>
                <span class="tag output">{{ detail.quangDauRa['ten_Quang'] }}</span>
              </div>
            </div>
            <div class="formula-actions">
              <button mat-icon-button 
                      color="primary" 
                      matTooltip="Sửa công thức" 
                      (click)="editCongThuc(detail)"
                      class="action-btn edit-btn">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button 
                      color="warn" 
                      matTooltip="Xóa công thức" 
                      (click)="deleteCongThuc(detail)"
                      class="action-btn delete-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          
          <div class="formula-content">
            <div class="table-container">
              <table class="formula-table">
                <thead>
                  <tr>
                    <th rowspan="2" class="ore-col">Quặng</th>
                    <th rowspan="2" class="ratio-col">Tỷ lệ (%)</th>
                    <th [attr.colspan]="getChemHeadersSorted(detail.id).length" class="chem-header">Thành phần hóa học</th>
                  </tr>
                  <tr>
                    <ng-container *ngFor="let h of getChemHeadersSorted(detail.id)">
                      <th class="chem-col">{{ h.ma }}</th>
                    </ng-container>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let r of getChemRows(detail.id)" [ngClass]="{'mixed-ore-row': isMixedOre(r)}">
                    <td class="ore-cell">
                      <span class="ore-name">{{ r.oreName }}</span>
                      <span *ngIf="isMixedOre(r)" class="mixed-badge">Phối</span>
                    </td>
                    <td class="ratio-cell">{{ r.ratio | number:'1.1-1' }}</td>
                    <ng-container *ngFor="let h of getChemHeadersSorted(detail.id)">
                      <td class="chem-cell">{{ getValue(detail.id, r, h.id) | number:'1.2-2' }}</td>
                    </ng-container>
                  </tr>
                  <tr class="result-row">
                    <td class="result-cell">{{ getOutName(detail.id) }}</td>
                    <td class="result-cell">100.0</td>
                    <ng-container *ngFor="let h of getChemHeadersSorted(detail.id)">
                      <td class="result-cell">{{ getOutValue(detail.id, h.id) | number:'1.2-2' }}</td>
                    </ng-container>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>


