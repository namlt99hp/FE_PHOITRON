<div class="summary-page">
  <header class="page-header">
    <div class="header-content">
      <button mat-icon-button (click)="onBack()" matTooltip="Quay lại" class="back-btn">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-title-block">
        <h1 class="page-title">Báo cáo tổng hợp</h1>
        <p class="page-subtitle">Gang đích: {{ maGang() }} <span class="id-badge">#{{ id() }}</span></p>
      </div>
    </div>
  </header>

  <main class="content">
    <div *ngIf="loading()" class="loading-state">
      <div class="loading-spinner"></div>
      <p class="loading-text">Đang tải dữ liệu...</p>
    </div>

    <div *ngIf="!loading() && plans().length === 0 && getInputPrices().length === 0" class="empty-state">
      <div class="empty-icon-wrap">
        <mat-icon>assessment</mat-icon>
      </div>
      <p class="empty-title">Chưa có dữ liệu tổng hợp</p>
      <p class="empty-desc">Chưa có phương án phối nào để hiển thị báo cáo.</p>
    </div>

    <div *ngIf="!loading() && (getInputPrices().length > 0 || plans().length > 0)" class="summary-body">
      <!-- Card: Giá đầu vào -->
      <section *ngIf="getInputPricesForDisplay().length > 0" class="summary-card card-prices">
        <div class="card-head">
          <h2 class="card-title">
            <mat-icon class="card-title-icon">local_offer</mat-icon>
            Giá đầu vào
          </h2>
          <div class="card-meta ty-gia-bar">
            <span class="ty-gia-label">Tỷ giá USD/VNĐ</span>
            <span class="ty-gia-value">{{ tyGiaUsdVnd() != null ? (tyGiaUsdVnd() | number:'1.0-0') : '—' }}</span>
            <span class="ty-gia-update" *ngIf="ngayTyGia()">{{ ngayTyGia() }}</span>
          </div>
        </div>
        <div class="card-body">
          <div class="table-scroll">
            <table class="price-table">
              <thead>
                <tr>
                  <th class="col-stt">STT</th>
                  <th class="col-name">Loại NNL</th>
                  <th class="col-num">USD</th>
                  <th class="col-num">VNĐ</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of getInputPricesForDisplay(); let i = index" [class.row-alt]="i % 2 === 1">
                  <td class="col-stt">{{ row.stt }}</td>
                  <td class="col-name">{{ row.loaiNNL }}</td>
                  <td class="col-num" [class.highlight]="row.highlightUsd">{{ formatUsd(row.usd) }}</td>
                  <td class="col-num" [class.highlight]="row.highlightVnd">{{ formatVnd(row.vnd) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Card: So sánh phương án -->
      <section *ngIf="plans().length > 0" class="summary-card card-compare">
        <div class="card-head">
          <h2 class="card-title">
            <mat-icon class="card-title-icon">compare_arrows</mat-icon>
            So sánh giữa các phương án
          </h2>
        </div>
        <div class="card-body">
          <div class="table-scroll compare-scroll">
            <table class="compare-table">
              <thead>
                <tr class="thead-main">
                  <th class="cell-label" >Phương Án</th>
                  <th *ngFor="let plan of getPlanColumns()" class="cell-plan">{{ plan }}</th>
                </tr>
                <tr class="thead-sub">
                  <th class="cell-label font-weight-bold">Tỷ lệ phối quặng vào TK</th>
                  <th *ngFor="let plan of getPlanColumns()" class="cell-ref">
                    {{ getThieuKetSumForPlan(plan) != null ? (getThieuKetSumForPlan(plan) | number:'1.0-2') : '—' }}%
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of getExcelData()"
                    [class.row-section]="row.isSectionHeader"
                    [class.row-bold]="row.isBold"
                    [class.row-highlight]="row.isYellow">
                  <td class="cell-label"
                      [class.cell-section]="row.isSectionHeader"
                      [class.cell-bold]="row.isBold">
                    {{ row.name }}
                  </td>
                  <!-- <td class="cell-unit">{{ row.unit || '—' }}</td> -->
                  <td *ngFor="let plan of getPlanColumns()"
                      class="cell-value"
                      [class.cell-bold]="row.isBold"
                      [class.cell-red]="row.isRed"
                      [class.cell-filled]="formatValue(row.values[plan], row.unit) !== ''">
                    {{ formatValue(row.values[plan], row.unit) }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>
